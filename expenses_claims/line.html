{{#load assign="claim" key=$_GET.claim}}
{{else}}
	{{:error message="Cette note de frais n'existe pas"}}
{{/load}}

{{#restrict section="accounting" level="write"}}
	{{:assign is_admin=true}}
{{else}}
	{{if $claim.user_id !== $logged_user.id}}
		{{:error message="L'acc√®s √† cette note de frais est interdit"}}
	{{/if}}
	{{:assign is_admin=false}}
{{/restrict}}

{{if $claim.status !== 'draft'}}
	{{:error message="Cette note de frais n'est pas un brouillon, il n'est pas possible de la modifier."}}
{{/if}}

{{:include file="./_config_default.tpl" keep="module.config,vehicles"}}

{{:assign var="categories_select.other" value="Autre"}}

{{#load type="category" assign="categories." order="$$.label COLLATE U_NOCASE"}}
	{{:assign var="categories_select[%s]"|args:$key value=$label}}
{{/load}}

{{#form on="save"}}
	{{if !$_POST.label|trim}}
		{{:error message="Le libell√© ne peut √™tre laiss√© vide"}}
	{{/if}}

	{{if $_POST.category !== 'other'}}
		{{#load type="category" key=$_POST.category assign="cat"}}
		{{else}}
			{{:error message="Cat√©gorie inconnue"}}
		{{/load}}
	{{/if}}

	{{:assign label=$_POST.label|trim}}

	{{if $cat.expense_type === 'km_vehicle'}}
		{{:assign distance=$_POST.distance|intval}}
		{{if !$_POST.vehicle|trim}}
			{{:error message="Aucun v√©hicule s√©lectionn√©"}}
		{{elseif $distance < 1}}
			{{:error message="La distance parcourue ne peut √™tre inf√©rieure √† 1 km"}}
		{{/if}}

		{{:include file="./_calcul_bareme.tpl" vehicule=$_POST.vehicle distance=$distance keep="resultat,calcul,bonus"}}
		{{:assign calcul_label=$calcul|replace:'d':$distance}}
		{{if $bonus > 1}}
			{{:assign bonus="+20% (v√©hicule √©lectrique)"}}
			{{:assign calcul_label="1,2 (bonus) x %s"|args:$calcul_label}}
		{{else}}
			{{:assign bonus="Non"}}
		{{/if}}
		{{:assign var="vehicle_name" from="vehicles.%s"|args:$_POST.vehicle}}
		{{:assign
			amount=$resultat
			label="%s (%s)"|args:$label:$calcul_label
			description="D√©part : %s\nArriv√©e : %s\nV√©hicule : %s\nDistance : %d km\nCalcul : %s\nBonus : %s\n\n%s"|args:$_POST.depart:$_POST.arrivee:$vehicle_name:$_POST.distance:$calcul:$bonus:$_POST.description|trim
		}}
	{{elseif $cat.expense_type === 'km_free'}}
		{{:assign distance=$_POST.distance|intval}}
		{{if $distance < 1}}
			{{:error message="La distance parcourue ne peut √™tre inf√©rieure √† 1 km"}}
		{{/if}}

		{{:assign bareme=$cat.price|money_currency:false:false:false}}
		{{:assign
			amount="%d*%d"|math:$distance:$cat.price|money_raw
			label="%s (%d x %s)"|args:$label:$distance:$bareme
			description="D√©part : %s\nArriv√©e : %s\nDistance : %s km\nBar√®me : %s par km\n\n%s"|args:$_POST.depart:$_POST.arrivee:$distance:$bareme:$_POST.description|trim
		}}
	{{/if}}

	{{:save
		validate_schema="./line.schema.json"
		key="uuid"
		type="line"
		claim=$claim.key
		label=$label
		category=$cat.label|or:'Autre'
		account=$cat.account|keys|key:0|strval|or:null
		description=$description|or:$_POST.description|trim|or:null
		amount=$amount|or:$_POST.amount|money_int
		reference=$_POST.reference|trim|or:null
		date=$_POST.date|parse_date|or:null
		id_project=$cat.id_project|intval|or:null
	}}
	{{:redirect to="details.html?key=%s"|args:$claim.key}}
{{/form}}

{{:admin_header title="Ajouter une ligne √† la note de frais n¬∞%d"|args:$claim.number}}

{{:form_errors}}

<form method="post" action="">
	<fieldset>
		<legend>D√©pense</legend>
		<dl>
			{{:input type="select" name="category" options=$categories_select label="Cat√©gorie" required=true default_empty="‚Äî S√©lectionner une cat√©gorie ‚Äî"}}
		</dl>
		<dl class="category">
			{{:input type="text" name="label" label="Libell√©" help="Inclure ici une description courte, par exemple 'Abonnement fibre atelier, mars 2023'." required=true}}
		</dl>
		<dl class="amount">
			{{:input type="money" name="amount" label="Montant total" required=true}}
		</dl>
	</fieldset>
	<fieldset class="vehicle km">
		<legend>Trajet</legend>
		<dl class="vehicle">
			{{:input type="select" name="vehicle" options=$vehicles label="Type de v√©hicule" required=true}}
			<dd class="carbone">--
			</dd>
		</dl>
		<dl class="vehicle km">
			{{:input type="text" name="depart" label="Lieu de d√©part" required=true}}
			{{:input type="text" name="arrivee" label="Lieu d'arriv√©e" required=true}}
			{{:input type="number" name="distance" options=$vehicles label="Distance parcourue" required=true min=1 step=1 size=5}}
			<dd class="help">
				Le bar√®me sera calcul√© lors de l'enregistrement, en fonction de la distance et du type de v√©hicule.
			</dd>
		</dl>
	</fieldset>
	<fieldset class="category">
		<legend>D√©tails</legend>
		<dl>
			{{:input type="date" name="date" label="Date de la d√©pense"}}
			{{:input type="text" name="reference" label="R√©f√©rence du justificatif" help="Par exemple : num√©ro de facture, nom du magasin, etc."}}
			{{:input type="textarea" name="description" label="Description"}}
			<dd class="alert block" id="notes"></dd>
		</dl>
	</fieldset>

	<p class="submit">
		{{:button type="submit" shape="right" label="Enregistrer" name="save" class="main"}}
	</p>
</form>

<script type="text/javascript">
var categories = {{$categories|values|json_encode|raw}};
categories.push({"label": "Autre", "key": "other", "expense_type": "other"});

var s = $('#f_category');

function selectCategory() {
	var category = null;

	Object.values(categories).forEach((c) => {
		if (c.key !== s.value) {
			return;
		}

		if (c.expense_type === 'km_vehicle' && localStorage.getItem('last_vehicle')) {
			v.value = localStorage.getItem('last_vehicle');
		}

		g.toggle('.category, p.submit', true);
		g.toggle('.vehicle', c.expense_type === 'km_vehicle');
		g.toggle('.amount', c.expense_type !== 'km_vehicle' && c.expense_type !== 'km_free');
		g.toggle('.km', c.expense_type === 'km_vehicle' || c.expense_type === 'km_free');

		var notes = $('#notes');

		g.toggle(notes, !!c.notes);
		notes.innerText = c.notes || '';
		notes.innerHTML = notes.innerHTML.replace(/\r?\n|\r/, "<br>");

		if (c.price) {
			$('#f_amount').value = g.formatMoney(c.price);
		}
	});
}

function selectVehicle() {
	var g;
	if (v.value == 'speedbike') {
		g = 11;
	}
	else if (v.value.substr(0, 5) === 'emoto' || v.value === 'ecyclomoteur') {
		g = 80;
	}
	else if (v.value === 'moto6cv') {
		g = 476;
	}
	else if (v.value.match(/moto|cyclomoteur/)) {
		g = 350;
	}
	else if (v.value === 'e3cv') {
		g = 64;
	}
	else if (v.value === 'e4cv') {
		g = 99;
	}
	else if (v.value.substr(0, 1) === 'e') {
		g = 139;
	}
	else {
		g = 300;
	}

	var msg = g >= 100 ? '<b class="error">V√©hicule tr√®s polluant ‚òπ</b>' : '<span class="confirm">V√©hicule peu polluant üòä</span>';
	msg += '<br />√âmet <b>' + g + '</b> gCO2/km.';
	$('.carbone')[0].innerHTML = msg;
}

g.toggle('.category, .vehicle, .amount, p.submit', false);
s.onchange = selectCategory;

selectCategory();

var v = $('#f_vehicle');

v.onchange = () => {
	localStorage.setItem('last_vehicle', v.value);
	selectVehicle();
};
selectVehicle();

</script>

{{:admin_footer}}
